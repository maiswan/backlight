from typing import Iterable, List, Literal
from pydantic import Field, model_validator
from .command_source_base import CommandSourceBase

class CommandSourceKelvin(CommandSourceBase):
    mode: Literal["source_kelvin"] = "source_kelvin"
    kelvin: float = Field(ge=1000, le=12000, default=6500)
    is_static = True

    def _compute(self, buffer: List[tuple[float, float, float]], targets: Iterable[int], time: float):
        r, g, b = self._kelvinToRgb()
        for i in targets:
            buffer[i] = (r, g, b)

    def _kelvinToRgb(self):
        kelvin_table = {
             1000: (1,	0.220,	0),
             1100: (1,	0.278,	0),
             1200: (1,	0.325,	0),
             1300: (1,	0.365,	0),
             1400: (1,	0.396,	0),
             1500: (1,	0.427,	0),
             1600: (1,	0.451,	0),
             1700: (1,	0.475,	0),
             1800: (1,	0.494,	0),
             1900: (1,	0.514,	0),
             2000: (1,	0.541,	0.071),
             2100: (1,	0.557,	0.129),
             2200: (1,	0.576,	0.173),
             2300: (1,	0.596,	0.212),
             2400: (1,	0.616,	0.247),
             2500: (1,	0.631,	0.282),
             2600: (1,	0.647,	0.310),
             2700: (1,	0.663,	0.341),
             2800: (1,	0.678,	0.369),
             2900: (1,	0.694,	0.396),
             3000: (1,	0.706,	0.420),
             3100: (1,	0.722,	0.447),
             3200: (1,	0.733,	0.471),
             3300: (1,	0.745,	0.494),
             3400: (1,	0.757,	0.518),
             3500: (1,	0.769,	0.537),
             3600: (1,	0.780,	0.561),
             3700: (1,	0.788,	0.580),
             3800: (1,	0.800,	0.600),
             3900: (1,	0.808,	0.624),
             4000: (1,	0.820,	0.639),
             4100: (1,	0.827,	0.659),
             4200: (1,	0.835,	0.678),
             4300: (1,	0.843,	0.694),
             4400: (1,	0.851,	0.714),
             4500: (1,	0.859,	0.729),
             4600: (1,	0.867,	0.745),
             4700: (1,	0.875,	0.761),
             4800: (1,	0.882,	0.776),
             4900: (1,	0.890,	0.792),
             5000: (1,	0.894,	0.808),
             5100: (1,	0.902,	0.824),
             5200: (1,	0.910,	0.835),
             5300: (1,	0.914,	0.851),
             5400: (1,	0.922,	0.863),
             5500: (1,	0.925,	0.878),
             5600: (1,	0.933,	0.890),
             5700: (1,	0.937,	0.902),
             5800: (1,	0.941,	0.914),
             5900: (1,	0.949,	0.925),
             6000: (1,	0.953,	0.937),
             6100: (1,	0.957,	0.949),
             6200: (1,	0.961,	0.961),
             6300: (1,	0.965,	0.969),
             6400: (1,	0.973,	0.984),
             6500: (1,	0.976,	0.992),
             6600: (0.996,	0.976,	1),
             6700: (0.988,	0.969,	1),
             6800: (0.976,	0.965,	1),
             6900: (0.969,	0.961,	1),
             7000: (0.961,	0.953,	1),
             7100: (0.953,	0.949,	1),
             7200: (0.941,	0.945,	1),
             7300: (0.937,	0.941,	1),
             7400: (0.929,	0.937,	1),
             7500: (0.922,	0.933,	1),
             7600: (0.914,	0.929,	1),
             7700: (0.906,	0.925,	1),
             7800: (0.902,	0.922,	1),
             7900: (0.894,	0.918,	1),
             8000: (0.890,	0.914,	1),
             8100: (0.882,	0.910,	1),
             8200: (0.878,	0.906,	1),
             8300: (0.871,	0.902,	1),
             8400: (0.867,	0.902,	1),
             8500: (0.863,	0.898,	1),
             8600: (0.855,	0.898,	1),
             8700: (0.851,	0.890,	1),
             8800: (0.847,	0.890,	1),
             8900: (0.843,	0.886,	1),
             9000: (0.839,	0.882,	1),
             9100: (0.831,	0.882,	1),
             9200: (0.827,	0.878,	1),
             9300: (0.824,	0.875,	1),
             9400: (0.820,	0.875,	1),
             9500: (0.816,	0.871,	1),
             9600: (0.812,	0.867,	1),
             9700: (0.812,	0.867,	1),
             9800: (0.808,	0.863,	1),
             9900: (0.804,	0.863,	1),
            10000: (0.812,	0.855,	1),
            10100: (0.812,	0.855,	1),
            10200: (0.808,	0.851,	1),
            10300: (0.804,	0.851,	1),
            10400: (0.800,	0.847,	1),
            10500: (0.800,	0.847,	1),
            10600: (0.796,	0.843,	1),
            10700: (0.792,	0.843,	1),
            10800: (0.792,	0.839,	1),
            10900: (0.788,	0.839,	1),
            11000: (0.784,	0.835,	1),
            11100: (0.784,	0.835,	1),
            11200: (0.780,	0.831,	1),
            11300: (0.776,	0.831,	1),
            11400: (0.776,	0.831,	1),
            11500: (0.773,	0.827,	1),
            11600: (0.773,	0.827,	1),
            11700: (0.773,	0.824,	1),
            11800: (0.769,	0.824,	1),
            11900: (0.765,	0.824,	1),
            12000: (0.765,	0.820,	1),
        }

        kelvin = round(self.kelvin, -2)
        return kelvin_table.get(kelvin, (0, 0, 0))
        